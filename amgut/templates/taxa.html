{%extends sitebase.html%}
{% block head %}
{% from amgut import text_locale, media_locale %}
{% set tl = text_locale['taxa.html'] %}
  <script src="/static/vendor/js/Chart.bundle.min.js"></script>
  <script src="/static/vendor/js/chroma.min.js"></script>
  <script src="/static/js/interactive.js"></script>
  <script type="text/javascript">
  var barChartSummaryData = {
    labels: {% raw [b['barcode'] + ' - ' + t for b, t in zip(barcodes, titles)] %},
    rawLabels: null,
    datasets: null,
    rawData: {% raw datasets %},
    metaData: null
  };
  var barChartFoldData = {
    labels: [],
    datasets: [],
    barcodes: {% raw [b['barcode'] for b in barcodes] %},
    titles: {% raw titles %}
  };
  var available_summaries = {% raw available_summaries %};
  var translate_summaries = {% raw text_locale['interactive_categories'] %};

window.onload = function() {
var ctx = document.getElementById("canvas-bar-summary").getContext("2d");
var ctf = document.getElementById("canvas-bar-fold").getContext("2d");
// Exploit JSON to make extremely fast deep copy of objects
barChartSummaryData.metaData = JSON.parse(JSON.stringify(barChartSummaryData.rawData));
barChartSummaryData.rawLabels = JSON.parse(JSON.stringify(barChartSummaryData.labels));
barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, 'phylum', 10);
window.summaryBar = new Chart(ctx, {
  type: 'bar',
  data: barChartSummaryData,
  barStrokeWidth:0,
  options: {
    legend: {
      position: 'top'
    },
    title:{
      display:true,
      text:"{% raw tl['TAX_REL_ABUNDANCES'] %}"
    },
    tooltips: {
      mode: 'label', // single if just want one OTU
    },
    responsive: true,
    scales: {
      xAxes: [{
        stacked: true,
        showVerticalLines: false
      }],
      yAxes: [{
        stacked: true,
        display: true,
        scaleLabel: {
          display: true,
          labelString: "{% raw tl['PERCENT_ABUNDANCE'] %}"
        },
      }]
    }
    }
});

window.foldBar = new Chart(ctf, {
  type: 'bar',
  data: barChartFoldData,
  barStrokeWidth:0,
  options: {
    legend: {
      display: false
    },
    title:{
      display:true,
      text:"{% raw tl['TAX_FOLD_CHANGES'] %}"
    },
    tooltips: {
      mode: 'single',
    },
    responsive: true,
    scales: {
      xAxes: [{
        ticks: {
          autoSkip: false
        }
      }],
      yAxes: [{
        display: true,
        scaleLabel: {
          display: true,
          labelString: "{% raw tl['LOG2_FOLD_CHANGE'] %}"
        }
      }]
      }
    }
  });
  fold_change();
  //fill categories based on site
  buildCats($('#barcode-fold option:selected').data('site'), $('#meta-cat-fold'), false);

  $("#collapse-fold").on("change", fold_change);

  $("#barcode-fold").on("change", function () {
    buildCats($('#barcode-fold option:selected').data('site'), $('#meta-cat-fold'), false);
    fold_change();

  });

  $("#meta-cat-fold").on("change", fold_change);

  $("#canvas-bar-summary").on('click', function(evt){
    var activePoints = window.summaryBar.getElementAtEvent(evt);
    if (activePoints.length > 0 && $("#collapse").val() != "genus") {
      var taxa = activePoints[0]._model.datasetLabel;
      if(taxa == "Other") {
        return;
      }
      var label = activePoints[0]._model.label;
      var prev_level = $("#collapse").val();
      $("#collapse > option:selected").prop("selected", false).next().prop("selected", true);
      barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, $("#collapse").val(), 10, prev_level, taxa);
      window.summaryBar.update();
    }
  });

  $("#collapse").on("change", function () {
    barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, $("#collapse").val(), 10);
    window.summaryBar.update();
  })

  $("#reset-summary").on("click", function () {
    $("#collapse").val('phylum');
    barChartSummaryData.labels = JSON.parse(JSON.stringify(barChartSummaryData.rawLabels));
    barChartSummaryData.metaData = JSON.parse(JSON.stringify(barChartSummaryData.rawData));
    barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, 'phylum', 10);
    //re-add all remove links
    $.each($("td"), function( i, val ) { val.remove(); });
    for(var i=0;i<barChartSummaryData.labels.length;i++) {
      var rem = $('<td><a href="#" onclick="remove_sample(\'' + barChartSummaryData.labels[i] + '\'); return false;">{% raw tl["REMOVE"] %}</a></td>');
      $("#remove-row").append(rem);
    }
    window.summaryBar.update();
  });
  $("#meta-site").on("change", function (evt) {
    var site = $("#meta-site").val();
    var catDropdown = $("#meta-cat");
    buildCats(site, catDropdown);
  });
  $("#meta-cat").on("change", function (evt) {
    if($("#meta-cat").val() == "") {
      $("#add-sumary-cat").prop("disabled", true);
    } else {
      $("#add-sumary-cat").prop("disabled", false);
    }
  });
  $("#meta-cat").prop("disabled", true);
  $("#add-sumary-cat").prop("disabled", true);
};
  </script>
  <style>
  canvas {
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
  }
  </style>
{% end%}
{% block content %}
<div id="taxa-summary-wrapper" style="width:100%; position: relative;">
<div id="taxa-summary-controls">
  <h3>{% raw tl['REL_TAXONOMY'] %}</h3>
    {% raw tl['SELECT_LEVEL'] %}:
    <select id="collapse">
      <option value="phylum">{% raw tl['PHYLUM'] %}</option>
      <option value="class">{% raw tl['CLASS'] %}</option>
      <option value="order">{% raw tl['ORDER'] %}</option>
      <option value="family">{% raw tl['FAMILY'] %}</option>
      <option value="genus">{% raw tl['GENUS'] %}</option>
    </select> <button id="reset-summary">{% raw tl['RESET_GRAPH'] %}</button><br/>
    {% raw tl['ADD_SITE'] %} <select id="meta-site">
      <option value=""></option>
      <option value="stool">{% raw tl['STOOL'] %}</option>
      <option value="skin">{% raw tl['SKIN'] %}</option>
      <option value="oral">{% raw tl['ORAL'] %}</option>
    </select> 
    {% raw tl['CATEGORY'] %}:<select id="meta-cat">
      <option value=""></option>
    </select><button onclick="add_metadata_barchart()" id="add-sumary-cat">{% raw tl['ADD'] %}</button>
  </div>
  <div style="width: 100%;">
      <canvas id="canvas-bar-summary"></canvas>
      <table style="width:94%; float:right;" id="remove-table"><tr id="remove-row">
    {% for b, t in zip(barcodes, titles) %}
      <td><a href="#" onclick="remove_sample('{% raw b['barcode'] + ' - ' + t %}'); return false;">{% raw tl['REMOVE'] %}</a></td>
    {% end %}
      </tr></table>
  </div>
</div>
<div id="taxa-summary-text" style="position:relative;clear: right;padding:5px;text-align: left;">
{% raw tl['TAXA_CHART_TEXT'] %}
</div>
<hr>
<div id="taxa-fold-wrapper" style="width:100%; position: relative;">
    <div id="taxa-fold-controls">
    <table style="width: 70%"><tr><td>
      <h3>{% raw tl['EXPLORE_IN_DETAIL'] %}</h3>
      {% raw tl['SAMPLE'] %}:
      <select id="barcode-fold">
    {% for bc in barcodes %}
      {% if collapse[bc['site_sampled']] == '' %}
        {% continue %}
      {% end %}
        <option value="{{bc['barcode']}}" data-site="{{collapse[bc['site_sampled']].lower()}}">{{bc['barcode']}} - {{bc['sample_date'].strftime('%b %d, %Y')}}</option>
    {% end %}
      </select>
    </td><td>
    <h3>{% raw tl['COMPARE_POP'] %}</h3>
    {% raw tl['SELECT_LEVEL'] %}:
    <select id="collapse-fold">
      <option value="phylum">{% raw tl['PHYLUM'] %}</option>
      <option value="class">{% raw tl['CLASS'] %}</option>
      <option value="order">{% raw tl['ORDER'] %}</option>
      <option value="family">{% raw tl['FAMILY'] %}</option>
      <option value="genus">{% raw tl['GENUS'] %}</option>
    </select>
    {% raw tl['CATEGORY'] %}:<select id="meta-cat-fold">
    <option value=''></option>
    </select>
    </td></tr>
  </table>
  </div>
  <div style="width: 59%; float:left;">
      <canvas id="canvas-bar-fold"></canvas>
  </div>
  <div style="width: 39%; float:left;"><h4>{% raw tl['ALPHA_DIVERSITY'] %}</h4><img src="" id="alpha-div-image" style="vertical-align: middle; width: 100%;"></div>
</div>
<div id="taxa-fold-text-wrapper" style="width:100%; position: relative;">
    <div id="taxa-fold-text" style="width: 59%; float: left; padding:5px; text-align: left;">
    {% raw tl['COMP_CHART_TEXT'] %}
    </div>
    <div id="alpha-div-text" style="width: 39%; float: left; padding:5px; text-align: left;">
    {% raw tl['ALPHA_DIV_TEXT'] %}
    </div>
</div>
{% end %}
